from datetime import datetime
from typing import Dict, Any
from uuid import uuid4
from config.aws import get_cognito_client
from repository.admin_repository import AdminRepository
from utility.auth import verify_cognito_token
from utility.errors import ApiError
from utility.logger import get_logger
from utility.security import hash_password
from config.settings import get_settings
settings = get_settings()

cognito_client = get_cognito_client()

class AdminService:
    def __init__(self, repository: AdminRepository):
        self._repository = repository
        self._logger = get_logger(self.__class__.__name__)

    def register_admin(self, payload: Dict[str, Any], tenant: str) -> Dict[str, Any]:
        try:
            email = payload["email"].strip().lower()
            existing = self._repository.get_by_email(email)
            if existing:
                raise ApiError("Email exists", 409, "email_exists")

            now = datetime.utcnow().isoformat()

            # create user in Cognito
            cognito_client.admin_create_user(
                UserPoolId=settings.cognito_user_pool_id,
                Username=email,
                UserAttributes=[
                    {"Name": "email", "Value": email},
                    {"Name": "email_verified", "Value": "True"},
                    {"Name": "custom:tenant", "Value": tenant},
                    {"Name": "custom:role", "Value": "admin"}
                ],
                TemporaryPassword=payload["password"],
                MessageAction="SUPPRESS"
            )

            cognito_client.admin_set_user_password(
                UserPoolId=settings.cognito_user_pool_id,
                Username=email,
                Password=payload["password"],
                Permanent=True
            )

            cognito_client.admin_add_user_to_group(
                UserPoolId=settings.cognito_user_pool_id,
                Username=email,
                GroupName="admin"
            )

            tokens = cognito_client.admin_initiate_auth(
                UserPoolId=settings.cognito_user_pool_id,
                ClientId=settings.cognito_client_id,
                AuthFlow="ADMIN_NO_SRP_AUTH",
                AuthParameters={"USERNAME": email, "PASSWORD": payload["password"]}
            ).get("AuthenticationResult")

            admin_id = verify_cognito_token(tokens["AccessToken"])["sub"]

            # store in DB
            self._repository.put_item({
                "PK": "USER",
                "SK": f"ADMIN#{admin_id}",
                "admin_id": admin_id,
                "email": email,
                "first_name": payload.get("first_name"),
                "last_name": payload.get("last_name"),
                "first_login": False,#True,
                "created_at": now,
                "updated_at": now
            })

            return {"admin_id": admin_id, "email": email, "tokens": tokens}

        except ApiError:
            raise
        except Exception as e:
            self._logger.error(f"Error in register_admin: {e}")
            raise ApiError("Internal server error", 500, "internal_error")

    # def login_admin(self, payload: Dict[str, Any]) -> Dict[str, Any]:
    #     try:
    #         email = payload.get("email", "").strip().lower()
    #         password = payload.get("password")
    #         if not email or not password:
    #             raise ApiError("Missing credentials", 400, "missing_credentials")

    #         tokens = cognito_client.admin_initiate_auth(
    #             UserPoolId=settings.cognito_user_pool_id,
    #             ClientId=settings.cognito_client_id,
    #             AuthFlow="ADMIN_NO_SRP_AUTH",
    #             AuthParameters={"USERNAME": email, "PASSWORD": password}
    #         ).get("AuthenticationResult")

    #         admin_id = verify_cognito_token(tokens["AccessToken"])["sub"]

    #         record = self._repository.get_item(admin_id)
    #         if not record:  # first login, insert
    #             now = datetime.utcnow().isoformat()
    #             self._repository.put_item({
    #                 "PK": "USER",
    #                 "SK": f"ADMIN#{admin_id}",
    #                 "admin_id": admin_id,
    #                 "email": email,
    #                 "created_at": now,
    #                 "updated_at": now
    #             })
    #             record = {"admin_id": admin_id, "email": email}

    #         return {"admin_id": record["admin_id"], "email": record["email"], "tokens": tokens}

    #     except ApiError:
    #         raise
    #     except Exception as e:
    #         self._logger.error(f"Error in login_admin: {e}")
    #         raise ApiError("Internal server error", 500, "internal_error")
    def login_admin(self, payload: Dict[str, Any]) -> Dict[str, Any]:
        try:
            email = payload.get("email", "").strip().lower()
            password = payload.get("password")
            new_password = payload.get("new_password")

            if not email or not password:
                raise ApiError("Missing credentials", 400, "missing_credentials")

            tokens = cognito_client.admin_initiate_auth(
                UserPoolId=settings.cognito_user_pool_id,
                ClientId=settings.cognito_client_id,
                AuthFlow="ADMIN_NO_SRP_AUTH",
                AuthParameters={"USERNAME": email, "PASSWORD": password}
            ).get("AuthenticationResult")

            claims = verify_cognito_token(tokens["AccessToken"])
            admin_id = claims["sub"]

            record = self._repository.get_item(admin_id)
            print("record---",admin_id)
            if not record:
                raise ApiError("Internal server error", 500, "internal_error")
            if not record:
                now = datetime.utcnow().isoformat()
                self._repository.put_item({
                        "PK": "USER",
                        "SK": f"ADMIN#{admin_id}",
                        "admin_id": admin_id,
                        "email": email,
                        "created_at": now,
                        "updated_at": now
                    })

            if record.get("first_login"):
                if not new_password:
                    return {"first_login": True}

                cognito_client.admin_set_user_password(
                    UserPoolId=settings.cognito_user_pool_id,
                    Username=email,
                    Password=new_password,
                    Permanent=True
                )

                self._repository.update_item(
                    admin_id,
                    {"first_login": False, "updated_at": datetime.utcnow().isoformat()}
                )

                tokens = cognito_client.admin_initiate_auth(
                    UserPoolId=settings.cognito_user_pool_id,
                    ClientId=settings.cognito_client_id,
                    AuthFlow="ADMIN_NO_SRP_AUTH",
                    AuthParameters={"USERNAME": email, "PASSWORD": new_password}
                ).get("AuthenticationResult")

            return {
                "first_login": False,
                "admin_id": admin_id,
                "email": email,
                "tokens": tokens
            }

        except ApiError:
            raise
        except Exception as e:
            self._logger.error(f"Error in login_admin: {e}")
            raise ApiError("Internal server error", 500, "internal_error")


    def get_profile_by_id(self, admin_id: str) -> Dict[str, Any]:
        try:
            print("admin_id",admin_id)
            record = self._repository.get_item(admin_id)
            if not record:
                raise ApiError("Admin not found", 404, "admin_not_found")

            return {
                "admin_id": record["admin_id"],
                "email": record["email"],
                "first_name": record.get("first_name"),
                "last_name": record.get("last_name")
            }

        except ApiError:
            raise
        except Exception as e:
            self._logger.error(f"Error in get_profile_by_id: {e}")
            raise ApiError("Internal server error", 500, "internal_error")
    
    def get_profile(self, payload: Dict[str, Any]) -> Dict[str, Any]:
        """
        Retrieve admin profile details.
        """

        record = self._repository.get_item(payload["admin_id"])
        if not record:
            raise ApiError("Admin not found", 404, "admin_not_found")

        profile = {
            "admin_id": record["admin_id"],
            "email": record["email"],
            "first_name": record.get("first_name"),
            "last_name": record.get("last_name"),
        }
        return profile
